# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  init:
    desc: Initialize Brewfile
    cmds:
      - ln -sf $(pwd)/Brewfile ~/Brewfile
  list:
    cmds:
      - brew list -1 --cask --full-name
      - brew list --installed-on-request --full-name

  diff:
    cmds:
      - git reset HEAD ./Brewfile
      - git --no-pager diff ./Brewfile
    silent: true

  bundle:
    desc: Generate Brewfile
    vars:
      FORMULAE:
        sh: brew list --installed-on-request --full-name
      CASKS:
        sh: brew list --cask --full-name
    cmds:
      - rm -f ./Brewfile
      - touch ./Brewfile
      - for: { var: FORMULAE }
        cmd: echo 'brew "{{.ITEM}}"' >> ./Brewfile
      - echo '' >> ./Brewfile
      - for: { var: CASKS }
        cmd: echo 'cask "{{.ITEM}}"' >> ./Brewfile
      - task: push
    silent: true

  push:
    deps:
      - diff
    desc: Push Brewfile to Remote Repository
    prompt: 上記の差分をリモートリポジトリにプッシュしますか?
    cmds:
      - git reset HEAD
      - git add ./Brewfile
      - git commit -m "Update Brewfile"
      - git push
    silent: true
    preconditions:
      - sh: "! git diff --exit-code ./Brewfile"

  reset:
    deps:
      - diff
    desc: Reset Local Brewfile to Remote Condition
    prompt: 上記の差分をリセットしますか?
    cmds:
      - git checkout -- ./Brewfile
      - brew bundle cleanup --force
    silent: true
    preconditions:
      - sh: "! git diff --exit-code ./Brewfile"
